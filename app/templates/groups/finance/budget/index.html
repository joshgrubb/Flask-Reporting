{% extends "base.html" %}

{% block title %}
{{ title }}
{% endblock %}

{% block cdn_resources %}
{{ include_cdn(bundles=["core", "chartjs", "datepicker"]) }}
{% endblock %}

{% block styles %}
<style>
    .chart-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 400px;
        width: 100%;
    }

    .chart-container {
        position: relative;
        height: 600px;
        width: 100%;
    }

    /* Error message styling */
    .chart-error {
        padding: 20px;
        background-color: var(--danger-light);
        color: var(--danger-color);
        border-radius: 8px;
        margin-top: 20px;
        display: none;
    }

    /* Summary stats card styling */
    .stats-card {
        transition: all 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
    }

    /* Dark mode specific styles */
    .dark-mode .stats-card {
        background-color: var(--card-background);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    .dark-mode .stats-card h2 {
        color: var(--primary-color);
    }

    .dark-mode .stats-card .text-muted {
        color: var(--text-muted) !important;
    }

    .dark-mode .form-select,
    .dark-mode .form-control {
        background-color: var(--surface-color);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    /* Fix for card headers in dark mode */
    .dark-mode .card-header.bg-primary {
        background-color: var(--primary-color) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/groups/">Groups</a></li>
                <li class="breadcrumb-item"><a href="/groups/finance/">Finance</a></li>
                <li class="breadcrumb-item active">Budget Dashboard</li>
            </ol>
        </nav>
        <h1><i class="fas fa-chart-line"></i> {{ title }}</h1>
        <p class="lead">View budget trends and data across fiscal years</p>
    </div>
</div>

<!-- Filters Section -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form id="filterForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="fiscalYearSelect" class="form-label">Fiscal Year</label>
                            <select class="form-select" id="fiscalYearSelect" name="fiscal_year">
                                <option value="">All Years</option>
                                {% for year in fiscal_years %}
                                <option value="{{ year.Fiscal_Year }}" {% if selected_fiscal_year==year.Fiscal_Year
                                    %}selected{% endif %}>
                                    {{ year.Fiscal_Year }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="departmentSelect" class="form-label">Department</label>
                            <select class="form-select" id="departmentSelect" name="department">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                {% if dept.Department and dept.Department != 'None' %}
                                <option value="{{ dept.Department }}" {% if selected_department==dept.Department
                                    %}selected{% endif %}>
                                    {{ dept.Department }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <button type="button" id="applyFilters" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button type="button" id="exportData" class="btn btn-success float-end">
                                <i class="fas fa-file-export"></i> Export to CSV
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Chart Section -->
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Amended Budget by Fiscal Year</h5>
            </div>
            <div class="card-body">
                <!-- Loading indicator -->
                <div id="chartLoading" class="chart-loading">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-3">Loading chart data...</div>
                    </div>
                </div>

                <!-- Chart container -->
                <div id="chartContainer" class="chart-container" style="display: none;">
                    <canvas id="budgetChart"></canvas>
                </div>

                <!-- Error message container -->
                <div id="chartError" class="chart-error">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage">Error loading chart data.</span>
                    <button id="retryButton" class="btn btn-outline-danger btn-sm ms-3">Retry</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Stats Section (will be populated by JavaScript) -->
<div class="row mt-4" id="statsSection" style="display: none;">
    <div class="col-md-4">
        <div class="card stats-card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie"></i> Average Budget
                </h5>
                <h2 class="mt-3 mb-0" id="averageBudget">-</h2>
                <p class="text-muted">Across selected period</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stats-card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-line"></i> Growth Trend
                </h5>
                <h2 class="mt-3 mb-0" id="growthTrend">-</h2>
                <p class="text-muted">Average yearly change</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stats-card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-calendar-alt"></i> Data Points
                </h5>
                <h2 class="mt-3 mb-0" id="dataPointCount">-</h2>
                <p class="text-muted">Number of fiscal years</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Custom JS for this report -->
<script src="{{ url_for('static', filename='js/finance/budget_dashboard.js') }}"></script>

<script>
    // Export button functionality
    document.addEventListener('DOMContentLoaded', function () {
        const exportBtn = document.getElementById('exportData');
        if (exportBtn) {
            exportBtn.addEventListener('click', function () {
                // Get current filter values
                const fiscalYear = document.getElementById('fiscalYearSelect').value;
                const department = document.getElementById('departmentSelect').value;

                // Build export URL
                let url = '/groups/finance/budget/export';
                let params = [];

                if (fiscalYear) {
                    params.push('fiscal_year=' + encodeURIComponent(fiscalYear));
                }

                if (department) {
                    params.push('department=' + encodeURIComponent(department));
                }

                if (params.length > 0) {
                    url += '?' + params.join('&');
                }

                // Open in new tab
                window.open(url, '_blank');
            });
        }
    });

    // Custom event for dark mode changes
    document.addEventListener('DOMContentLoaded', function () {
        // Create custom event
        const darkModeChangedEvent = new CustomEvent('darkModeChanged');

        // Find theme toggle button
        const themeToggle = document.getElementById('toggle-theme');
        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                // Dispatch custom event after a short delay
                setTimeout(() => {
                    document.dispatchEvent(darkModeChangedEvent);
                }, 100);
            });
        }
    });
</script>
{% endblock %}