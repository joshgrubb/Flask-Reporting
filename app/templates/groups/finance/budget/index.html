{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block styles %}
<style>
    .chart-container {
        height: 400px;
        position: relative;
        margin-bottom: 20px;
    }

    .filter-section {
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
    }

    .metric-card {
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        text-align: center;
    }

    .metric-card h3 {
        margin-top: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .metric-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .metric-card .percent {
        font-size: 1.2rem;
        margin-top: 0.5rem;
    }

    .dark-mode .plotly-graph {
        background-color: var(--card-background) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/groups/">Groups</a></li>
                <li class="breadcrumb-item"><a href="/groups/finance/">Finance</a></li>
                <li class="breadcrumb-item active">Budget Dashboard</li>
            </ol>
        </nav>
        <h1><i class="fa-solid fa-file-invoice-dollar"></i> {{ title }}</h1>
        <p class="lead">Interactive budget analysis and reporting dashboard.</p>
    </div>
</div>

<!-- Filters Section -->
<div class="row mb-4">
    <div class="col">
        <div class="filter-section">
            <form id="filterForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="fiscalYearSelect" class="form-label">Fiscal Year</label>
                        <select class="form-select" id="fiscalYearSelect" name="fiscal_year">
                            {% for year in fiscal_years %}
                            <option value="{{ year.Fiscal_Year }}" {% if year.Fiscal_Year==default_fiscal_year
                                %}selected{% endif %}>
                                {{ year.Fiscal_Year }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="fundCategorySelect" class="form-label">Fund Category</label>
                        <select class="form-select" id="fundCategorySelect" name="fund_category">
                            <option value="">All Categories</option>
                            {% for category in fund_categories %}
                            <option value="{{ category.Fund_Category }}">
                                {{ category.Fund_Category }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="applyFilters" class="btn btn-primary me-2">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <button type="button" id="resetFilters" class="btn btn-outline-secondary">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Summary Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <h3>Total Budget</h3>
            <div class="value" id="totalBudget">$0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <h3>Total Spent</h3>
            <div class="value" id="totalSpent">$0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <h3>Total Encumbered</h3>
            <div class="value" id="totalEncumbered">$0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <h3>Remaining Budget</h3>
            <div class="value" id="remainingBudget">$0</div>
            <div class="percent" id="percentRemaining">0%</div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Budget vs. Actual by Fund</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <div id="budgetByFundChart" class="plotly-graph"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Budget Utilization</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <div id="budgetUtilizationChart" class="plotly-graph"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Monthly Budget vs. Actual Trends</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <div id="monthlyTrendChart" class="plotly-graph"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Data Table -->
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between">
                <h5 class="mb-0">Departmental Budget Breakdown</h5>
                <button class="btn btn-sm btn-light" id="exportData">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="budgetTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Fund</th>
                                <th>Department</th>
                                <th>Division</th>
                                <th>Budget</th>
                                <th>Actual</th>
                                <th>Encumbrance</th>
                                <th>Remaining</th>
                                <th>% Spent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in budget_data %}
                            <tr>
                                <td>{{ row.Fund }}</td>
                                <td>{{ row.Department }}</td>
                                <td>{{ row.Division }}</td>
                                <td>${{ '%0.2f'|format(row.TotalBudget|float) }}</td>
                                <td>${{ '%0.2f'|format(row.TotalActual|float) }}</td>
                                <td>${{ '%0.2f'|format(row.TotalEncumbrance|float) }}</td>
                                <td>${{ '%0.2f'|format(row.RemainingBudget|float) }}</td>
                                <td>{{ '%0.1f'|format(row.PercentSpent|float) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
<script>
    // Store the initial chart data
    let budgetSummaryData = {{ budget_summary_chart_data| safe }};
    let monthlyTrendData = {{ monthly_trend_chart_data| safe }};

    // Wait for document to be ready
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize charts
        createBudgetByFundChart();
        createBudgetUtilizationChart();
        createMonthlyTrendChart();
        updateSummaryMetrics();

        // Initialize DataTable
        if (typeof $.fn.DataTable === 'function') {
            $('#budgetTable').DataTable({
                pageLength: 10,
                order: [[0, 'asc'], [1, 'asc']],
                responsive: true
            });
        }

        // Add event listeners for filter controls
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        document.getElementById('exportData').addEventListener('click', exportData);
    });

    // Dark mode detection for charts
    function isDarkMode() {
        return document.documentElement.classList.contains('dark-mode');
    }

    // Chart color scheme based on mode
    function getColorScheme() {
        return isDarkMode() ?
            ['#6FA3FF', '#9AA4AC', '#68D391', '#FFB74D'] :
            ['#4361ee', '#4F6D7A', '#2E7D32', '#FF8C00'];
    }

    // Create Budget by Fund Chart
    function createBudgetByFundChart() {
        const uniqueFunds = [...new Set(budgetSummaryData.funds)];

        // Aggregate data by fund
        const fundData = uniqueFunds.map(fund => {
            const indices = budgetSummaryData.funds.map((f, i) => f === fund ? i : -1).filter(i => i !== -1);

            return {
                fund: fund,
                budget: indices.reduce((sum, i) => sum + budgetSummaryData.budget_values[i], 0),
                actual: indices.reduce((sum, i) => sum + budgetSummaryData.actual_values[i], 0),
                encumbrance: indices.reduce((sum, i) => sum + budgetSummaryData.encumbrance_values[i], 0)
            };
        });

        // In your createMonthlyTrendChart function, add a month sorting order
        const monthOrder = {
            'January': 1, 'February': 2, 'March': 3, 'April': 4,
            'May': 5, 'June': 6, 'July': 7, 'August': 8,
            'September': 9, 'October': 10, 'November': 11, 'December': 12
        };

        // Sort the data by month number
        const sortedData = monthlyTrendData.months.map((month, i) => ({
            month: month,
            monthNum: monthlyTrendData.monthNum[i],
            budget: monthlyTrendData.monthly_budget[i],
            actual: monthlyTrendData.monthly_actual[i],
            running: monthlyTrendData.running_actual[i]
        })).sort((a, b) => a.monthNum - b.monthNum);

        // Update the chart data arrays
        const sortedMonths = sortedData.map(d => d.month);
        const sortedBudget = sortedData.map(d => d.budget);
        const sortedActual = sortedData.map(d => d.actual);
        const sortedRunning = sortedData.map(d => d.running);

        // Use the sorted arrays in your chart
        const trace1 = {
            x: sortedMonths,
            y: sortedBudget,
            name: 'Monthly Budget',
            type: 'bar',
            marker: { color: getColorScheme()[0] }
        };

        const trace2 = {
            x: fundData.map(d => d.fund),
            y: fundData.map(d => d.actual),
            name: 'Actual',
            type: 'bar',
            marker: { color: getColorScheme()[1] }
        };

        const trace3 = {
            x: fundData.map(d => d.fund),
            y: fundData.map(d => d.encumbrance),
            name: 'Encumbrance',
            type: 'bar',
            marker: { color: getColorScheme()[2] }
        };

        const layout = {
            barmode: 'group',
            margin: { t: 10, r: 10, b: 80, l: 80 },
            legend: { orientation: 'h', y: -0.2 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: isDarkMode() ? '#E0E0E0' : '#333333' },
            yaxis: {
                title: 'Amount ($)',
                tickformat: '$,.0f',
                gridcolor: isDarkMode() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
            },
            xaxis: {
                title: 'Fund',
                gridcolor: isDarkMode() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
            }
        };

        Plotly.newPlot('budgetByFundChart', [trace1, trace2, trace3], layout, { responsive: true });
    }

    // Create Budget Utilization Chart
    function createBudgetUtilizationChart() {
        // Create traces for the chart
        const trace = {
            x: budgetSummaryData.percent_spent,
            y: budgetSummaryData.fund_department_labels,
            type: 'bar',
            orientation: 'h',
            marker: {
                color: budgetSummaryData.percent_spent.map(p => {
                    if (p < 50) return 'rgba(46, 125, 50, 0.7)'; // Green
                    if (p < 75) return 'rgba(255, 140, 0, 0.7)'; // Orange
                    if (p < 100) return 'rgba(255, 140, 0, 0.9)'; // Dark Orange
                    return 'rgba(211, 47, 47, 0.7)'; // Red
                })
            }
        };

        const layout = {
            margin: { t: 10, r: 20, b: 40, l: 200 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: isDarkMode() ? '#E0E0E0' : '#333333' },
            xaxis: {
                title: 'Percentage Spent (%)',
                range: [0, Math.max(100, ...budgetSummaryData.percent_spent) + 10],
                gridcolor: isDarkMode() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
            },
            yaxis: {
                gridcolor: isDarkMode() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
            }
        };

        Plotly.newPlot('budgetUtilizationChart', [trace], layout, { responsive: true });
    }

    // Create Monthly Trend Chart
        function createMonthlyTrendChart() {
            // Create traces for the chart
            const trace1 = {
                x: monthlyTrendData.months,
                y: monthlyTrendData.monthly_budget,
                name: 'Monthly Budget',
                type: 'bar',
                marker: { color: getColorScheme()[0] }
            };

            const trace2 = {
                x: monthlyTrendData.months,
                y: monthlyTrendData.monthly_actual,
                name: 'Monthly Actual',
                type: 'bar',
                marker: { color: getColorScheme()[1] }
            };

            const trace3 = {
                x: monthlyTrendData.months,
                y: monthlyTrendData.running_actual,
                name: 'Running Actual',
                type: 'scatter',
                mode: 'lines+markers',
                yaxis: 'y2',
                line: { color: getColorScheme()[3], width: 3 },
                marker: { size: 8 }
            };

            const layout = {
                barmode: 'group',
                margin: { t: 10, r: 50, b: 80, l: 80 },
                legend: { orientation: 'h', y: -0.2 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: isDarkMode() ? '#E0E0E0' : '#333333' },
                yaxis: {
                    title: 'Monthly Amount ($)',
                    tickformat: '$,.0f',
                    gridcolor: isDarkMode() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                },
                yaxis2: {
                    title: 'Running Total ($)',
                    titlefont: { color: getColorScheme()[3] },
                    tickfont: { color: getColorScheme()[3] },
                    overlaying: 'y',
                    side: 'right',
                    tickformat: '$,.0f',
                    gridcolor: 'transparent'
                },
                xaxis: {
                    title: 'Month',
                    gridcolor: isDarkMode() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                }
            };

            Plotly.newPlot('monthlyTrendChart', [trace1, trace2, trace3], layout, { responsive: true });
        }

        // Update Summary Metrics
        function updateSummaryMetrics() {
            // Calculate summary metrics
            const totalBudget = budgetSummaryData.budget_values.reduce((sum, val) => sum + val, 0);
            const totalActual = budgetSummaryData.actual_values.reduce((sum, val) => sum + val, 0);
            const totalEncumbrance = budgetSummaryData.encumbrance_values.reduce((sum, val) => sum + val, 0);
            const remaining = totalBudget - totalActual - totalEncumbrance;
            const percentRemaining = totalBudget > 0 ? (remaining / totalBudget) * 100 : 0;

            // Update the DOM elements
            document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
            document.getElementById('totalSpent').textContent = formatCurrency(totalActual);
            document.getElementById('totalEncumbered').textContent = formatCurrency(totalEncumbrance);
            document.getElementById('remainingBudget').textContent = formatCurrency(remaining);
            document.getElementById('percentRemaining').textContent = percentRemaining.toFixed(1) + '% Remaining';

            // Change color based on percentage
            const percentEl = document.getElementById('percentRemaining');
            if (percentRemaining < 10) {
                percentEl.style.color = 'var(--danger-color)';
            } else if (percentRemaining < 30) {
                percentEl.style.color = 'var(--warning-color)';
            } else {
                percentEl.style.color = 'var(--success-color)';
            }
        }

        // Format currency values
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Apply filters from the form
        function applyFilters() {
            const fiscalYear = document.getElementById('fiscalYearSelect').value;
            const fundCategory = document.getElementById('fundCategorySelect').value;

            // Show loading spinner or message
            document.getElementById('budgetByFundChart').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            document.getElementById('budgetUtilizationChart').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            document.getElementById('monthlyTrendChart').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // Make API calls for new data
            // 1. Get budget summary data
            fetch(`/groups/finance/budget/api/budget-summary?fiscal_year=${fiscalYear}&fund_category=${fundCategory}`)
                .then(response => response.json())
                .then(response => {
                    if (response.success) {
                        budgetSummaryData = response.data;
                        createBudgetByFundChart();
                        createBudgetUtilizationChart();
                        updateSummaryMetrics();

                        // Refresh the table data
                        window.location.href = `/groups/finance/budget/?fiscal_year=${fiscalYear}&fund_category=${fundCategory}`;
                    } else {
                        showError('Error loading budget summary data: ' + response.error);
                    }
                })
                .catch(error => {
                    showError('Error loading budget summary data: ' + error);
                });

            // 2. Get monthly trend data
            fetch(`/groups/finance/budget/api/monthly-trend?fiscal_year=${fiscalYear}`)
                .then(response => response.json())
                .then(response => {
                    if (response.success) {
                        monthlyTrendData = response.data;
                        createMonthlyTrendChart();
                    } else {
                        showError('Error loading monthly trend data: ' + response.error);
                    }
                })
                .catch(error => {
                    showError('Error loading monthly trend data: ' + error);
                });
        }

        // Reset filters to defaults
        function resetFilters() {
            // Reset form elements
            document.getElementById('fiscalYearSelect').selectedIndex = 0;
            document.getElementById('fundCategorySelect').selectedIndex = 0;

            // Apply the filters
            applyFilters();
        }

        // Export data to CSV
        function exportData() {
            const fiscalYear = document.getElementById('fiscalYearSelect').value;
            const fundCategory = document.getElementById('fundCategorySelect').value;

            // Build export URL
            let url = '/groups/finance/budget/export?';
            if (fiscalYear) url += `fiscal_year=${fiscalYear}&`;
            if (fundCategory) url += `fund_category=${fundCategory}`;

            // Open in new tab
            window.open(url, '_blank');
        }

        // Show an error message
        function showError(message) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.setAttribute('role', 'alert');

            // Add alert content
            alertDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

            // Find alert container
            const alertContainer = document.getElementById('alert-container');
            if (alertContainer) {
                // Add to alert container
                alertContainer.appendChild(alertDiv);
            } else {
                // Add to top of main content
                const mainContent = document.querySelector('main.container');
                if (mainContent) {
                    mainContent.insertBefore(alertDiv, mainContent.firstChild);
                }
            }

            // Auto-close after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 150);
            }, 5000);
        }

        // Update charts when dark mode changes
        document.addEventListener('darkModeChanged', function () {
            createBudgetByFundChart();
            createBudgetUtilizationChart();
            createMonthlyTrendChart();
        });
    </script>
{% endblock %}